<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>添加事件</title>
		<link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/bootstrap-table.min.css"/>
		<link src="../../css/layer.css" type="text/javascript" charset="utf-8"></link>
		<link rel="stylesheet" type="text/css" href="../../css/common.css"/>
		<link rel="stylesheet" id="deepColour" type="text/css" href="../../css/deepColor.css"/>
		<style type="text/css">
			.propertyNav{
				margin-bottom:10px;
				/* display:none; */
			}
			.propertyNav a{
				font-size:12px;
				margin:10px;
				color:#428bca;
			}
			.propertyNav a:hover{
				text-decoration: underline;
			}
			.content .emptyBox{
				width:20%;
				float:left;
				height:10px;
				transition: all 0.4s ease 0s;
			}
			.content .paramBox{
				width:60%;
				background:#2e3e4e;
				padding:20px;
				float:left;				
			}
			.content .actionBox{
				width:40%;
			}
			.content .row{
				padding: 10px;
			}
			.content .row>div{
				padding-left:30px;
			}
			.content .row>div label{
				width: 100px;
				/* text-align: end; */
				float: left;
				height:34px;
				line-height: 34px;
				margin-right: 20px;
			}
			.content .row>div>input {
			    float: left;
			    width: 77%;
			}
			.content .row>div textarea {
			    float: left;
			    width: 77%;
			}
			.selectAction {
			    font-size: 12px!important;
			    color: #1ab394;
			    padding-left: 0!important;
			    border:0!important;
			}
			.selectAction:hover{
				color: #1ab394;
		    	text-decoration: underline;
		    	background: 0;
		    	border:0;
			}
			.selectedActionBox {
			    border: 0;
			    background: 0;
			    color: #56a4ef;
			    box-shadow: 0px 0px 7px 1px #4781bb;
			    min-height: 100px;
			    padding:5px;
			    
			}
			.selectedActionBox table{
				overflow:hidden;
			}
			.selectedActionBox tbody tr{
				cursor:move;
			}
			.selectedActionBox tbody i {
				margin-right:5px;
				cursor:pointer;
			}
			.inputWarpper{
				padding:0;
				width:77%;
				float: left;
			}
			.actionBox{
				 box-shadow: 0px 0px 7px 1px #4781bb;
				 padding:10px;
				 height:90vh;
				 position:fixed;
				 top:20px;
				 /* right:10px; */
				 right:-52%;
				 transition:all 0.5s;
			}
			.actionBox button{
				background:#386c9a!important;
				width:53px;
			}
			.actionBox tbody tr{
				cursor:pointer;
				user-select:none;
			}
			.layui-layer-content{
				padding:10px;
			}
			.alarmBox{
				height:0;
				overflow:hidden;
				transition: all 0.4s ease 0s;
			}
			.timeBox{
				display:flex;
			}
			.timeBox span{
				display: inline-block;
    			width: 25%;
			}
			.btnBox{
				display:flex;
				justify-content:center;
			}
			.submitParam{
				background:#386c9a!important;
				margin:0 20px;
			}
			.goBack{
				border:1px solid #386c9a;
				color:#fff;
				margin:0 20px;
			}
			.goBack:hover{
				color:#fff;
			}
		</style>
	</head>
	<body>
		<div id="box">
			<div class="top_title">
				新增事件
			</div>
			<div class="propertyNav">
				<a href="eventList.html">事件列表</a>><a class="secondA" href="addEvent.html">新增事件</a> <a href="eventList.html">返回上一级</a>
			</div>
			<!-- javascript:void(0) -->
			<div class="content">
				<div class="emptyBox"></div>
				<div class="paramBox">
					<div class="row">
						<div class="col-sm-12">
							<label>事件名称  ：</label>
	    					<input type="text" class="form-control eventName"  placeholder="事件名称">
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12">
							<label>动作名称  ：</label>
	    					<div class="inputWarpper">
	    						<div style="margin-bottom:10px;"><a href="javascript:void(0);" class="selectAction">选择动作</a><span class="selectActionDes">(可拖拽排序)</span></div>
	    						<div class="selectedActionBox">
	    							<table data-toggle="table" data-classes="table table-hover ">
										<thead>
											<tr>
												<th>动作名称</th>
												<th>创建人</th>
												<th>资产名称</th>
												<th>日志类型</th>
												<th>关键字</th>
												<th>次数</th>
												<th>操作</th>
											</tr>
										</thead>
										<tbody id="selectedActionBox">
											
										</tbody>
									</table>
	    							
	    						</div>
	    						
	    					</div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12">
							<label>是否启用  ：</label>
							<div class="inputWarpper" style="height:34px;line-height: 34px;">
								<input type="radio" name="isUsed" value="1" checked class="yes">是
	    						<input type="radio" name="isUsed" value="0" class="no">否
							</div> 				
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12">
							<label>是否告警  ：</label>
	    					<div class="inputWarpper" style="height:34px;line-height: 34px;">
								<input type="radio" name="isAlarm" value="1"  class="yes">是
	    						<input type="radio" name="isAlarm" value="0" checked class="no">否
							</div> 	
						</div>
					</div>
					<div class="alarmBox">
						<div class="row">
							<div class="col-sm-12">
								<label>策略名称 ：</label>
		    					<input type="text" class="form-control alarmName"  placeholder="策略名称">
							</div>
						</div>
						<div class="row">
							<div class="col-sm-12">
								<label>选择时间 ：</label>
								<div class="inputWarpper timeBox">
									<span>
										<label>月</label>
										<select class="form-control safe_month">
											<option value="00"></option>
										</select>
									</span>
									<span>
										<label>日</label>
										<select class="form-control safe_day">
											<option value="00"></option>
										</select>
									</span>
									<span>
										<label>时</label>
										<select class="form-control safe_hour">
											<option value="00"></option>
										</select>
									</span>
									<span>
										<label>分</label>
										<select class="form-control safe_min">
											<option value="00"></option>
										</select>
									</span>
								</div>
							</div>	
						</div>
					</div>
					
					<div class="row">
						<div class="col-sm-12">
							<label>事件描述  ：</label>
	    					<textarea class="form-control eventDes"></textarea>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12 btnBox">
							<button class="btn btn-info submitParam">提交</button>
							<button class="btn goBack">返回</button>
						</div>
					</div>
					
				</div>
				<div class="actionBox">
					<div style="margin-bottom:10px;"><button class="btn btn-info  closeActionBox">关闭</button></div>
					<table data-toggle="table" data-classes="table ">
						<thead>
							<tr>
								<th>动作名称</th>
								<th>创建人</th>
								<th>资产名称</th>
								<th>日志类型</th>
								<th>关键字</th>
							</tr>
						</thead>
						<tbody id="acl">
							<!-- <tr>
								<td>登录</td>
								<td>李洪连</td>
								<td>jr</td>
								<td>winlog</td> 
							</tr> -->
						</tbody>
					</table>
				</div>
			</div>
		</div>
		
		
		
		<script src="../../js/jquery-2.1.0.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/bootstrap-table/js/bootstrap-table.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/bootstrap-table/js/bootstrap-table-zh-CN.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/layer.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/Sortable.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/ajax.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" charset="utf-8">
			
			//获取动作列表数据
			$.ajax({
				url:'../../action/selectAll.do',
				data:'',
				type:"post",  //提交方式  
		        dataType:"json", //数据类型  
				success:function(data){
					//填充数据
					var html = '';
					for(var i in data[0]){
						var obj = data[0][i];
						//拼接
						html += '<tr data-id="'+obj.id+'" class="actionTr">'
			                 +		'<td class="action_name">'+obj.name+'</td>'
			                 +		'<td class="action_user">'+obj.userName+'</td>'
			                 +		'<td class="action_eqName">'+obj.equipmentName+'</td>'
			                 +		'<td class="action_logType">'+obj.type+'</td>'
	 		                 +		'<td class="action_keyWords">'+obj.feature+'</td>'
	 		                /*      +		'<td class="action_eqUser">'+obj.equipmentUserName+'</td>' */
			                 +	'</tr>'
					}
			        $(".actionBox tbody").html(html);
			        
			      //添加鼠标拖拽排序问题		 
					 var list = document.getElementById("acl");
					 var sort1 = new Sortable(list,{
						 group:{
							 name:"actionBox",
							 pull:"clone",
							 put:false
						 },
						 sort:false,
						 animation: 150
					 }); 	
					 
				}
			});
		  	
			 //添加鼠标拖拽排序问题		 
			 var list = document.getElementById("selectedActionBox");
			 var sort2 = new Sortable(list,{
				 group:{
					 name:"actionBox",
					 pull:false
				 },
				 animation: 150,
				 //列表被添加元素事件
				 onAdd:function(evt){
					 //删除空结果提示
					 $(".no-records-found").remove();
					 //定义初始次数
					 var actionNum = 1;		
					 //出现弹窗
					 layer.open({				
				 		type: 1,
				 		title:'动作次数',//标题
						area: ['250px', '170px'], //宽高
						btn: ['确定'], //按钮
						btn1:function(index){
							layer.close(index);
							actionNum = $(".layui-layer-input").val();
					    	$(evt.item).append('<td class="actionNum">'+actionNum+'</td><td><i class="glyphicon glyphicon-edit edit" title="修改"></i><i class="glyphicon glyphicon-remove removeAction" title="删除"></i></td>');								
						},
						content:'<input type="number" class="form-control layui-layer-input" style="margin-top: 10px;"  autofocus="autofocus" value="1">'
				 	})
				 	$(".layui-layer-setwin").remove();
				 } 
			 }); 
			 //修改动作次数按钮
			 $("#selectedActionBox").on("click",".edit",function(){
				 var $this = $(this);
				 var actionNum = $this.parent().siblings(".actionNum").html()
					//弹窗				 
				 	layer.open({				
				 		type: 1,
				 		title:'修改次数',//标题
						area: ['250px', '170px'], //宽高
						btn: ['确定'], //按钮
						btn1:function(index){
							layer.close(index);
							var num = $(".layui-layer-input").val();	
							$this.parent().siblings(".actionNum").html(num)
						},
						content:'<input type="number" class="form-control layui-layer-input" style="margin-top: 10px;"  autofocus="autofocus" value="'+actionNum+'">'
				 	})
			 })
			 //删除所选动作事件
			 $("#selectedActionBox").on("click",".removeAction",function(){
				var $this = $(this); 
				//询问框
				layer.confirm('确定删除？', {
				  btn: ['确定','取消'] //按钮
				}, function(index){
					layer.close(index);
					$this.parents('tr').remove();
				}, function(){
					  layer.close();
				});
				  
			  })
			 
			//点击选择动作按钮 右边滑出动作列表
			$(".selectAction").click(function(){
				$(".actionBox").css("right","10px");
				$(".emptyBox").css("width","0");
				$(".selectedActionBox").css("border","2px solid #e4956d");
			})
			//关闭动作列表
			$(".closeActionBox").click(function(){
				$(".selectedActionBox").css("border","0");
				$(".actionBox").css("right","-52%");
				$(".emptyBox").css("width","20%");
			})
			
			//是否告警点击出现策略选项
			$("input[name='isAlarm']").click(function(){
				if($(this).val() == "1"){
					$(".alarmBox").css("height","152px");
				}else{
					$(".alarmBox").css("height","0");
				}
			})
			
			
			//添加月
		  	for(var i = 1;i <= 12;i++){
		  		$(".safe_month").append('<option value="'+i+'">'+i+'</option>');
		  	}
		  	//添加日
		  	for(var i = 1;i <= 30;i++){
		  		$(".safe_day").append('<option value="'+i+'">'+i+'</option>');
		  	}
		  	//添加时
		  	for(var i = 1;i <= 24;i++){
		  		$(".safe_hour").append('<option value="'+i+'">'+i+'</option>');
		  	}
		  	//添加分
		  	for(var i = 1;i <= 60;i++){
		  		$(".safe_min").append('<option value="'+i+'">'+i+'</option>');
		  	}
		  	
		  	//提交按钮 点击事件
		  	$(".submitParam").click(function(){
		  		//获取参数
		  		var ids = "";//选中的动作Id
				//获得修改后的事件名
				var eventName = $(".eventName").val();
				//是否启用状态
				var isUsedState = $("input[name='isUsed']:checked").val();
				//是否告警状态
				var isAlarmState = $("input[name='isAlarm']:checked").val();//enabled
				//获得事件描述
				var eventDes = $(".eventDes").val();
				//获得创建人
				var userId = JSON.parse(localStorage.getItem('LoginUser'))[0].id;
				//获得策略名称
				var alarmName = $(".alarmName").val();//safeStrategyName
				var month = $(".safe_month").val();
  				//日
  				var day = $(".safe_day").val();
  				//时
  				var hour = $(".safe_hour").val();
  				//分
  				var minute = $(".safe_min").val();
  				var actionList = $("#selectedActionBox .actionTr");
  				for(var i = 0;i < actionList.length;i++){
  					//id
  					var id = $(actionList[i]).attr("data-id");
  					//次数
  					var num = $(actionList[i]).children(".actionNum").html()
  					ids += id+'-'+i+'-'+num+',';
  				}
  				
  				//判断值的合法性
				if(eventName == ''){//事件名值为空
					layer.msg('事件名称不能为空',{icon: 5});
				}else if(ids == ''){//动作不能为空
					layer.msg('未添加任何动作',{icon: 5});
				}else if(eventDes == ''){//动作不能为空
					layer.msg('事件描述为空',{icon: 5});
				}else{
					var obj = {};
	  				obj.name = eventName;
	  				obj.state = isUsedState;
	  				obj.enabled = isAlarmState;
	  				obj.message = eventDes;
	  				obj.userId = userId;
	  				obj.safeStrategyName = alarmName;
	  				obj.month = month;
	  				obj.day = day;
	  				obj.hour = hour;
	  				obj.minute = minute;
	  				obj.actionId = ids;
	  				//成功函数
	  				var sFunc = function(data){
	  					if(data.success == "true"){//成功
							layer.msg(data.message,{icon: 1});
							//跳转到事件列表
							location.href="eventList.html"
							//关闭弹窗
							layer.close(index);
						}else if(data.success == "false"){//失败
							layer.msg(data.message,{icon: 5});
						} 
	  				}
	  				ajaxPost("../../event/insert.do",obj,sFunc);
				}
  				
  				
		  	})
		  	//返回按钮
		  	$(".goBack").click(function(){
		  		//跳转到事件列表
				location.href="eventList.html"
		  	})
		</script>
	</body>
</html>